stages:
 - version
 - build
 - test
 - publish

default:
  before_script:
    - mkdir build


get-version:
 stage: version
 tags:
  - docker-compose
 only:
  - master
  - develop
  - /^feature\/.*$/i
 script:
  - echo "Getting version for branch  $CI_COMMIT_REF_NAME"
  - ./ci/git-version.sh --url $CI_PROJECT_URL --branch $CI_COMMIT_REF_NAME --sha $CI_COMMIT_SHA --user $CI_GIT_USER --password $CI_GIT_PASSWORD  > ./build/version.json
  - NUGET_VERSION="$(./ci/git-version.sh --url $CI_PROJECT_URL --branch $CI_COMMIT_REF_NAME --sha $CI_COMMIT_SHA --user $CI_GIT_USER --password $CI_GIT_PASSWORD  -t SemVer)"
  - echo "Target version for nuget - $NUGET_VERSION"
 artifacts:
  name: "app_${CI_PROJECT_NAME}_${CI_COMMIT_REF_SLUG}_${CI_BUILD_REF}"
  when: on_success
  expire_in: 1 week
  paths:
   - build



# build_images:
#  stage: build
#  tags:
#   - docker-compose
#  only:
#   - master
#   - develop   
#  script:
#   - docker-compose -f docker-compose.yml -f docker-compose.prod.yml build


# deploy_prod_app:
#  stage: deploy
#  tags:
#   - docker-compose
#   - docker-deploy
#  only:
#   - master 
#  script:
#   - docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d